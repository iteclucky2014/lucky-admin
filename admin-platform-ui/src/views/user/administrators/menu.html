<title>菜单管理</title>

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a href="javascript:;" layadmin-event="flexible" title="侧边伸缩">
            <i class="layui-icon layui-icon-shrink-right" id="LAY_app_flexible"></i>
        </a>
        <a lay-href="">主页</a>
        <a><cite>系统设置</cite></a>
        <a><cite>菜单管理</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <button class="layui-btn layui-btn-primary add-root-menu">添加顶级菜单</button>
            <button class="layui-btn layui-btn-primary up-all">全部收起</button>
            <button class="layui-btn layui-btn-primary down-all">全部展开</button>

            <table class="layui-table layui-form" id="LAY-user-back-menu" lay-filter="LAY-user-back-menu"></table>

            <script type="text/html" id="table-useradmin-admin">
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
      </script>
        </div>
    </div>
</div>

<script>
    layui.use(['admin', 'treetable', 'table', 'form', 'layer'], function () {
        var $ = layui.$
            , admin = layui.admin
            , view = layui.view
            , table = layui.table
            , treetable = layui.treetable
            , layer = layui.layer
            , form = layui.form;

        var localData = layui.data(layui.setter.tableName);


        var renderTreeTable = function () {
            $.getJSON('/platform/menu/getMenuTreeGridData?access_token=' + localData["access_token"], function (resp) {
                if (resp.code === 0) {
                    var treetableData = resp.data || [];

                    //部门管理
                    treetable.render({
                        elem: '#LAY-user-back-menu'
                        , data: treetableData
                        , cellMinWidth: 100
                        , field: 'title'//以树形式显示的字段
                        , is_checkbox: true
                        , cols: [{ field: 'title', title: '菜单名称' }
                            , {
                            title: '状态',
                            width: 40,
                            template: function (item) {
                                console.log(item);
                                if (item.delFlag == 1) {
                                    return '<input type="checkbox" lay-skin="switch" lay-filter="status" lay-text="开启|关闭">';
                                } else {
                                    return '<input type="checkbox" checked lay-skin="switch" lay-filter="status" lay-text="开启|关闭">';
                                }
                            }
                        }
                            , {
                            title: '图标',
                            width: 40,
                            template: function (item) {
                                console.log(item);
                                if (item.icon != undefined) {
                                    return '<i class="layui-icon ' + item.icon + '"></i>';
                                }
                            }
                        }
                            , {
                            field: 'id',
                            width: 20,
                            title: 'ID'
                        }
                            , {
                            field: 'pid',
                            title: '父ID',
                            width: 20,
                        }
                            , {
                            field: 'dispOrder',
                            title: '显示顺序',
                            width: 20,
                        }
                            , {
                            field: 'actions',
                            title: '操作',
                            width: 100,
                            template: function (item) {
                                var tem = [];
                                tem.push('<a class="layui-btn layui-btn-sm layui-btn-normal" lay-filter="edit">编辑属性</a>');
                                tem.push('<a class="add-child layui-btn layui-btn-sm layui-btn-normal" lay-filter="add">添加子级</a>');
                                tem.push('<a class="add-child layui-btn layui-btn-sm layui-btn-normal" lay-filter="del">删除菜单</a>');
                                return tem.join('')
                            }
                        }
                        ]
                    });

                } else {
                    layer.msg(resp.msg, { icon: 6 });
                }
            });
        };
        renderTreeTable();

        treetable.on('treetable(add)', function (data) {
            console.dir(data);
            var formData = data.item;
            $.getJSON('/platform/role/page?page=1&limit=100&access_token=' + localData["access_token"], function (rep) {
                admin.popup({
                    title: '编辑菜单属性'
                    , area: ['500px', '700px']
                    , id: 'LAY-popup-user-add'
                    , success: function (layero, index) {
                        view(this.id).render('user/administrators/addMenuForm', formData).done(function () {
                            form.render(null, 'layuiadmin-form-admin');

                            // 动态生成角色复选框
                            var roles = rep.data || [];
                            roles.forEach(function (item) {
                                $("#LAY-popup-user-add-roles-checkbox").append('<input type="checkbox" name="platformRoles[]" title="' + item.roleName + '" value="' + item.id + '" lay-skin="primary">');
                            });

                            // 复选框初始化
                            var platformRoleIds = [];
                            console.log("--->" + JSON.stringify(formData));
                            formData.authorities.forEach(function (item) {
                                platformRoleIds.push(item.id);
                            });
                            $("#LAY-popup-user-add-roles-checkbox input").each(function () {
                                if ($.inArray(parseInt($(this).val()), platformRoleIds) != -1) {
                                    $(this).prop("checked", true);
                                } else {
                                    $(this).prop("checked", false);
                                }
                            });
                            form.render('checkbox');
                            //监听提交
                            form.on('submit(LAY-user-back-submit)', function (formData) {
                                var field = formData.field; //获取提交的字段
                                // 整理复选框数据
                                var platformRoles = [];
                                for (var key in field) {
                                    if (key.indexOf('platformRoles[') != -1) {
                                        platformRoles.push(field[key]);
                                    }
                                }
                                field['platformRoles'] = platformRoles;
                                var loading = layer.msg('处理中', { icon: 16, shade: 0.01, time: 0 });
                                $.ajax({
                                    url: '/platform/menu/addMenu?access_token=' + localData["access_token"]
                                    , type: 'POST'
                                    , contentType: 'application/json; charset=utf-8'
                                    , data: JSON.stringify({
                                        userid: '10001',
                                        username: 'admin',
                                        data: field
                                    })
                                    , dataType: 'json'
                                    , success: function (resp) {
                                        if (resp.code === 0) {
                                            layer.close(loading); //执行关闭
                                            renderTreeTable();
                                            layer.close(index); //执行关闭
                                        } else {
                                            layer.msg(resp.msg, { icon: 6 });
                                        }
                                    }
                                    , error: function (resp) {
                                        layer.msg(resp.msg, { icon: 6 });
                                    }
                                });

                            });
                        });
                    }
                });
            });
        });

        treetable.on('treetable(edit)', function (data) {
            console.dir(data);
            var formData = data.item;
            $.getJSON('/platform/role/page?page=1&limit=100&access_token=' + localData["access_token"], function (rep) {
                admin.popup({
                    title: '编辑菜单属性'
                    , area: ['500px', '700px']
                    , id: 'LAY-popup-user-add'
                    , success: function (layero, index) {
                        view(this.id).render('user/administrators/editMenuForm', formData).done(function () {
                            form.render(null, 'layuiadmin-form-admin');

                            // 动态生成角色复选框
                            var roles = rep.data || [];
                            roles.forEach(function (item) {
                                $("#LAY-popup-user-add-roles-checkbox").append('<input type="checkbox" name="platformRoles[]" title="' + item.roleName + '" value="' + item.id + '" lay-skin="primary">');
                            });

                            // 复选框初始化
                            var platformRoleIds = [];
                            console.log("--->" + JSON.stringify(formData));
                            formData.authorities.forEach(function (item) {
                                platformRoleIds.push(item.id);
                            });
                            $("#LAY-popup-user-add-roles-checkbox input").each(function () {
                                if ($.inArray(parseInt($(this).val()), platformRoleIds) != -1) {
                                    $(this).prop("checked", true);
                                } else {
                                    $(this).prop("checked", false);
                                }
                            });
                            form.render('checkbox');
                            //监听提交
                            form.on('submit(LAY-user-back-submit)', function (formData) {
                                var field = formData.field; //获取提交的字段
                                // 整理复选框数据
                                var platformRoles = [];
                                for (var key in field) {
                                    if (key.indexOf('platformRoles[') != -1) {
                                        platformRoles.push(field[key]);
                                    }
                                }
                                field['platformRoles'] = platformRoles;
                                var loading = layer.msg('处理中', { icon: 16, shade: 0.01, time: 0 });
                                $.ajax({
                                    url: '/platform/menu/editMenu?access_token=' + localData["access_token"]
                                    , type: 'POST'
                                    , contentType: 'application/json; charset=utf-8'
                                    , data: JSON.stringify({
                                        userid: '10001',
                                        username: 'admin',
                                        data: field
                                    })
                                    , dataType: 'json'
                                    , success: function (resp) {
                                        if (resp.code === 0) {
                                            layer.close(loading); //执行关闭
                                            renderTreeTable();
                                            layer.close(index); //执行关闭
                                        } else {
                                            layer.msg(resp.msg, { icon: 6 });
                                        }
                                    }
                                    , error: function (resp) {
                                        layer.msg(resp.msg, { icon: 6 });
                                    }
                                });

                            });
                        });
                    }
                });
            });
        });

        treetable.on('treetable(del)', function (data) {
            console.dir(data);
            var formData = data.item;

            layer.confirm('确定删除此菜单及其所有下级菜单吗？', function (index) {
                var ids = [];
                ids.push(formData.id);
                var loading = layer.msg('处理中', { icon: 16, shade: 0.01, time: 0 });
                $.ajax({
                    url: '/platform/menu/delete?access_token=' + localData["access_token"]
                    , type: 'POST'
                    , contentType: 'application/json; charset=utf-8'
                    , data: JSON.stringify({
                        userid: '10001',
                        username: 'admin',
                        data: ids
                    })
                    , dataType: 'json'
                    , success: function (resp) {
                        if (resp.code === 0) {
                            layer.close(loading); //执行关闭
                            table.reload('LAY-user-back-manage');
                            layer.msg('已删除');
                            renderTreeTable();
                        } else {
                            layer.msg(resp.msg, { icon: 6 });
                        }
                    }
                    , error: function (resp) {
                        layer.msg(resp.msg, { icon: 6 });
                    }
                });
            });

        });



        $('.up-all').click(function () {
            treetable.all('up');
        });

        $('.down-all').click(function () {
            treetable.all('down');
        });

        $('.add-root-menu').click(function () {
            $.getJSON('/platform/role/page?page=1&limit=100&access_token=' + localData["access_token"], function (rep) {
                var formData = {};
                formData.id = "";
                formData.pid = "";
                admin.popup({
                    title: '编辑菜单属性'
                    , area: ['500px', '700px']
                    , id: 'LAY-popup-user-add'
                    , success: function (layero, index) {
                        view(this.id).render('user/administrators/addMenuForm', formData).done(function () {
                            form.render(null, 'layuiadmin-form-admin');

                            // 动态生成角色复选框
                            var roles = rep.data || [];
                            roles.forEach(function (item) {
                                $("#LAY-popup-user-add-roles-checkbox").append('<input type="checkbox" name="platformRoles[]" title="' + item.roleName + '" value="' + item.id + '" lay-skin="primary">');
                            });
                            form.render('checkbox');
                            //监听提交
                            form.on('submit(LAY-user-back-submit)', function (formData) {
                                var field = formData.field; //获取提交的字段
                                // 整理复选框数据
                                var platformRoles = [];
                                for (var key in field) {
                                    if (key.indexOf('platformRoles[') != -1) {
                                        platformRoles.push(field[key]);
                                    }
                                }
                                field['platformRoles'] = platformRoles;
                                var loading = layer.msg('处理中', { icon: 16, shade: 0.01, time: 0 });
                                $.ajax({
                                    url: '/platform/menu/addMenu?access_token=' + localData["access_token"]
                                    , type: 'POST'
                                    , contentType: 'application/json; charset=utf-8'
                                    , data: JSON.stringify({
                                        userid: '10001',
                                        username: 'admin',
                                        data: field
                                    })
                                    , dataType: 'json'
                                    , success: function (resp) {
                                        if (resp.code === 0) {
                                            layer.close(loading); //执行关闭
                                            renderTreeTable();
                                            layer.close(index); //执行关闭
                                        } else {
                                            layer.msg(resp.msg, { icon: 6 });
                                        }
                                    }
                                    , error: function (resp) {
                                        layer.msg(resp.msg, { icon: 6 });
                                    }
                                });

                            });
                        });
                    }
                });
            });
        });

        form.on('switch(status)', function (data) {
            layer.msg('监听状态操作');
            console.log(data);
            console.log(data.elem.checked)

            // 获取当前控件
            var selectIfKey = data.othis;
            // 获取当前所在行
            var parentTr = selectIfKey.parents("tr");
            var id = $(parentTr).attr("data-id");
            console.log(id);


            var delFlag = 0;
            if (data.elem.checked) {
                delFlag = 0;
            } else {
                delFlag = 1;
            }
            $.ajax({
                url: '/platform/menu/logicDel/' + id + '/' + delFlag + '?access_token=' + localData["access_token"]
                , type: 'POST'
                , contentType: 'application/json; charset=utf-8'
                , data: JSON.stringify({
                    userid: '10001',
                    username: 'admin',
                    data: []
                })
                , dataType: 'json'
                , success: function (resp) {
                    if (resp.code === 0) {
                        layer.msg('已逻辑删除');
                        renderTreeTable();
                    } else {
                        layer.msg(resp.msg, { icon: 6 });
                    }
                }
                , error: function (resp) {
                    layer.msg(resp.msg, { icon: 6 });
                }
            });
        });




    });
</script>